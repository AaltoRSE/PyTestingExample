# This is simple test repository for automated testing.

This repository is used for automated testing as described in the [CodeRefinery Testing Lecture](https://coderefinery.github.io/testing/continuous-integration/).

Simply [fork](https://github.com/AaltoRSE/PyTestingExample/fork) it to your own github repositories, make a local clone
```
git clone https://github.com/<yourGitHubName>/PyTestingExample
```
and then follow the remaining [Steps 2.-11. in the exercise instructions](https://coderefinery.github.io/testing/continuous-integration/#step-2-run-tests-locally).

The "Solution" branch contains a version with all tests corrected and set up along with a template for the github action necessary. You can include it into your fork by unticking the box "Copy the `main` branch only" but this is not mandatory.

## The workflow script.

The following is an adaption of the default python package workflow that will in addition to running the tests, also create code coverage information for a pull request to main. 
This workflow differs to the one mentioned in the lesson by testing against multiple python versions. This is beneficial
for code that uses newer python features as it ensures backwards compatability to all tested versions. 

```yml
# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python package

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  
jobs:
  build:
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10"]

    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install flake8 pytest pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    - name: Test with pytest and calculate coverage
      run: |
        pytest --cov-report "xml:coverage.xml"  --cov=.
    - name: Create Coverage 
      if: ${{ github.event_name == 'pull_request' }}
      uses: orgoro/coverage@v3
      with:
          coverageFile: coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}

```
The changes to the original workflow are the following:


### Adding permissions to the workflow. 
```
    permissions:
      pull-requests: write
```
This is necessary to allow the workflow to actually write the coverage comment in the pull request, as otherwise the workflow would not have those permissions.

### Adding coverage generation to pytest 
This requires two modfications:
1. Installing the coverage dependency used by pytest:
   ```
   python -m pip install flake8 pytest pytest-cov
   ```
   in the `Install dependencies` step and
2. Actually generating the report in the `Test with pytest and calculate coverage`
   ```
    pytest --cov-report "xml:coverage.xml"  --cov=.
   ```
   `--cov-report "xml:coverage.xml"` generates a coverage report that can be interpreted by other tools that visualise it. `--cov=.` indicates, that the coverage is to be calculated for all files in this folder. Normally, you have a source folder or even a test folder that would be used here instead of the base folder. 

### Adding an action that generates the coverage report.
```
    - name: Create Coverage 
      if: ${{ github.event_name == 'pull_request' }}
      uses: orgoro/coverage@v3
      with:
          coverageFile: coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}
```
There are several different options to create a coverage report (just search for "python coverage github" on google...). We use a very simplistic one here because this doesn't need any registration. For a real project have a look e.g. at [codecov](https://about.codecov.io/).
Since we want to run this step on each pull request and each push to main, we also need to restrict this step to pull requests: `if: ${{ github.event_name == 'pull_request' }}` as otherwise the whole workflow is likely to fail because we can't write to a push. 
Finally, the `coverageFile` used here has to be the same as the one generated by the modified pytest run above.
